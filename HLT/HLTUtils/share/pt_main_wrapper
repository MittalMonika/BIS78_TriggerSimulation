#!/bin/bash
#

args="$*"

if [ ! -z "${HLT_VERBOSE}" ]; then
    echo "================================================================================"
    echo "Environment delivered to pt_main_wrapper script:"
    /usr/bin/printenv
    echo "================================================================================"
fi

#######################################################################
#	setup HLT
#######################################################################
echo "==============================================================="

set_coredump()
{
    # Set core dump limits if required and allowed
    if [ ! -z "${HLT_COREDUMPSIZE}" ]
	then
	echo "Setting core dump limits to: ${HLT_COREDUMPSIZE}"
	ulimit -c ${HLT_COREDUMPSIZE}
	ulimit -a
    fi
}


reverse_paths()
{
    result=""
    for p in `echo ${1} | tr ':' ' '`
    do
      result="${p} ${result}"
    done
    echo $result
}

update_paths()
{
    if [ ! -z "${HLT_EXTRA_SW_PATH}" ]
	then
	for dir in `reverse_paths ${HLT_EXTRA_SW_PATH}`
	  do
	  if [ -d ${dir} ]
	      then 
	      PATH=${dir}/InstallArea/share/bin:${dir}/InstallArea/${CMTCONFIG}/bin:${PATH}
	      LD_LIBRARY_PATH=${dir}/InstallArea/${CMTCONFIG}/lib:${LD_LIBRARY_PATH}
	      PYTHONPATH=${dir}/InstallArea/python:${PYTHONPATH}
	      JOBOPTSEARCHPATH=${dir}/InstallArea/jobOptions:${JOBOPTSEARCHPATH}
	      DATAPATH=${dir}/InstallArea/share:${DATAPATH}
	      XMLPATH=${dir}/InstallArea/XML:${XMLPATH}
              ROOTMAPSEARCHPATH=${dir}/InstallArea/rootmap:${ROOTMAPSEARCHPATH}
	  else
	      echo "WARNING: directory ${dir} does not exist !"
	  fi
	done 
	echo "PATH=`echo ${PATH} | tr ':' '\n'`"
	echo "LD_LIBRARY_PATH=`echo ${LD_LIBRARY_PATH} | tr ':' '\n'`"
	echo "PYTHONPATH=`echo ${PYTHONPATH} | tr ':' '\n'`"
	echo "JOBOPTSEARCHPATH=`echo ${JOBOPTSEARCHPATH} | tr ':' '\n'`"
	echo "DATAPATH=`echo ${DATAPATH} | tr ':' '\n'`"
	echo "XMLPATH=`echo ${XMLPATH} | tr ':' '\n'`"
    fi
}

update_paths
set_coredump

if [ ! -z "${HLT_VERBOSE}" ]; then    
    echo "================================================================================"
    echo "Environment before executing exec pt_main $args"
    printenv | sort
    echo "================================================================================"
fi

if [ ! -z "${HLT_PRELOAD}" ]; then
    export LD_PRELOAD="${HLT_PRELOAD}"
fi
exec pt_main $args

