#!/bin/sh

# run like so:
#  atl-gpt-cpu-profile myjobo.py -c 'EVTMAX=100'
function atl_gpt_cpu_profile()
{
    args=("$@")
    atl_gpt_cpuprofile=atl-gpt-$$.cpu.profile
    /bin/rm -rf ${atl_gpt_cpuprofile}* 2> /dev/null
    echo "::: running gpt-cpu-profiler (outfile=$atl_gpt_cpuprofile)..."
    TCMALLOCDIR=${ATLAS_GPERFTOOLS_DIR} \
    LD_PRELOAD=libtcmalloc_and_profiler.so \
    CPUPROFILE_FREQUENCY=1000 \
    CPUPROFILE=$atl_gpt_cpuprofile \
        `which python` `which athena.py` --stdcmalloc $args
    sc=$?
    echo "::: running gpt-cpu-profiler (outfile=$atl_gpt_cpuprofile)... [done]"
    return $sc
}

atl_gpt_cpu_profile "$@"

