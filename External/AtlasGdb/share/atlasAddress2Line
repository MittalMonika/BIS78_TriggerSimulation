#!/usr/bin/perl

use strict;
use Getopt::Long;

my $data = "none.file";
my $length = 24;
my $verbose;

my $result = GetOptions ("file=s" => \$data);

die "Please give a logfile to parse with the --file option !\n" if ( $data eq "none.file" );

open(FILE,"<$data") || die "Could not open logfile with name '$data' !!\n\n";
my @lines=<FILE>;
close(FILE);

my $coredump=0;
my $AtlasBaseDir="";
my $AtlasVersion="";
my $CMTCONFIG="";

foreach my $mline (@lines)
{
    $mline =~ s/\s+$//;
    
    if ( $coredump == 2 )
    {
	my ($addr,$lib,$reladdr) = ( $mline =~ /^ 0x(\S+) .+\[(\S+) D\[(\S+)\]\]/s );
	if ( $lib ne "" and $reladdr ne "" )
	{
	    $lib =~ s#$AtlasBaseDir#/afs/cern.ch/atlas/software/builds#g;
	    open(PIPE,"resolveAtlasAddr2Line.exe -f $lib -a $reladdr 2>/dev/null | ") or die "cannot open pipe !!";
	    my @pipe=<PIPE>;
	    close(PIPE);
	    my $exit = $?;
	    if ( $exit == 0 )
	    {
		print " 0x$addr @pipe";
	    } else {
		print $mline . "\n";
	    }
	} else {
	    print $mline . "\n";
	}
    }
    if ( $coredump == 1 )
    {
	print $mline . "\n";
	$coredump = 2 if ( $mline =~ /^stack trace:/s );
	if ( $mline =~ /^\| AtlasBaseDir :/s )
	{
	    ($AtlasBaseDir) = ( $mline =~ /^\| AtlasBaseDir :\s+(\S+) \|/s );
	    # print '3:' . $AtlasBaseDir . "\n";
	}	
	if ( $mline =~ /^\| AtlasVersion :/s )
	{
	    ($AtlasVersion) = ( $mline =~ /^\| AtlasVersion :\s+(\S+) \|/s );
	    # print '4:' . $AtlasVersion . "\n";
	}	
	if ( $mline =~ /^\| CMTCONFIG    :/s )
	{
	    ($CMTCONFIG) = ( $mline =~ /^\| CMTCONFIG    :\s+(\S+) \|/s );
	    # print '5:' . $CMTCONFIG . "\n";
	}
    }
    if ( $mline =~ /^Core dump from CoreDumpSvc on /s )
    {
	$coredump=1;
    }
}	
